import { useEffect, useMemo, useState, Suspense } from "react";
import { useLocation } from "react-router-dom";
import { ActiveApp, MenuItem } from "../../types";
import { useAuthStore } from "../../store/auth.store";
import { Card, Button, Typography, Spin, Alert } from "antd";
import { RocketOutlined, LoadingOutlined } from "@ant-design/icons";
import NoPermissionOverlay from "../NoPermissionOverlay";
import React from "react";

const { Title, Paragraph, Text } = Typography;

const SalesApp = React.lazy(() =>
  import("sales_visitor/App" as any).catch(() => {
    return {
      default: () => (
        <Alert
          message="Sales Application ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
          description={
            <div>
              <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Sales Remote Application ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>
              <p>
                <strong>Expected URL:</strong>{" "}
                http://localhost:3001/remoteEntry.js
              </p>
              <ol style={{ textAlign: "left", marginTop: "10px" }}>
                <li>‡πÄ‡∏õ‡∏¥‡∏î terminal ‡πÉ‡∏´‡∏°‡πà</li>
                <li>cd ‡πÑ‡∏õ‡∏¢‡∏±‡∏á remote app folder</li>
                <li>‡∏£‡∏±‡∏ô: npm start</li>
                <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ remote app ‡∏£‡∏±‡∏ô‡∏ó‡∏µ‡πà port 3001</li>
              </ol>
            </div>
          }
          type="warning"
          showIcon
        />
      ),
    };
  })
);

interface DashboardContentProps {
  activeApp: ActiveApp;
  menuItems: MenuItem[];
}

const DashboardContent: React.FC<DashboardContentProps> = ({
  activeApp,
  menuItems,
}) => {
  const location = useLocation();
  const [currentUrl, setCurrentUrl] = useState(window.location.href);
  const { Salesinfo, user, fetchSalesinfo, isloadingSalesinfo } =
    useAuthStore();

  const cleanUsername = (username: string): string => {
    return username.replace(/^QERP_/i, "");
  };

  useEffect(() => {
    if (user && user.username && !Salesinfo) {
      fetchSalesinfo(cleanUsername(user.username));
    }
  }, [user, Salesinfo]);

  useEffect(() => {
    const handleUrlChange = () => {
      const newUrl = window.location.href;
      setCurrentUrl(newUrl);
    };
    // Initial call
    handleUrlChange();

    window.addEventListener("hashchange", handleUrlChange);
    window.addEventListener("popstate", handleUrlChange);

    return () => {
      window.removeEventListener("hashchange", handleUrlChange);
      window.removeEventListener("popstate", handleUrlChange);
    };
  }, [activeApp]);

  const permissionStatus = useMemo(() => {
    if (activeApp.parentId === "home") {
      return { hasPermission: true, showLoading: false };
    }

    if (!user) {
      return { hasPermission: false, showLoading: false };
    }

    if (isloadingSalesinfo) {
      return { hasPermission: false, showLoading: true };
    }

    if (!Salesinfo) {
      return { hasPermission: false, showLoading: false };
    }

    return {
      hasPermission: Salesinfo.status,
      showLoading: false,
    };
  }, [activeApp.parentId, user, isloadingSalesinfo, Salesinfo]);

  const RemoteLoadingFallback: React.FC<{ appName: string }> = ({
    appName,
  }) => (
    <div
      style={{
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        height: "400px",
        flexDirection: "column",
        gap: "16px",
      }}
    >
      <Spin
        size="large"
        indicator={<LoadingOutlined style={{ fontSize: 32 }} spin />}
      />
      <div style={{ textAlign: "center" }}>
        <Text strong style={{ fontSize: "16px" }}>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î {appName}...
        </Text>
        <br />
        <Text type="secondary" style={{ fontSize: "14px" }}>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Remote App ‡∏ó‡∏µ‡πà port 3001
        </Text>
      </div>
    </div>
  );

  const RemoteErrorFallback: React.FC<{ appName: string; error?: string }> = ({
    appName,
    error,
  }) => (
    <div
      style={{
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        height: "100%",
        padding: "40px",
      }}
    >
      <Alert
        message={`${appName} ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`}
        description={
          <div>
            <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î {appName} ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
            {error && (
              <p style={{ fontSize: "12px", color: "#999" }}>Error: {error}</p>
            )}
            <div style={{ marginTop: "16px" }}>
              <Button
                type="primary"
                onClick={() => window.location.reload()}
                style={{ marginRight: "8px" }}
              >
                ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
              </Button>
              <Button onClick={() => console.log("Contact support")}>
                ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô
              </Button>
            </div>
          </div>
        }
        type="error"
        showIcon
        style={{ maxWidth: "600px" }}
      />
    </div>
  );

  const renderContent = useMemo(() => {
    if (activeApp.parentId === "home") {
      return (
        <div style={{ padding: "40px", textAlign: "center" }}>
          <h1>üè† Portal Dashboard</h1>

          <div
            style={{
              padding: "20px",
              backgroundColor: "#f0f8ff",
              borderRadius: "8px",
              marginBottom: "20px",
              maxWidth: "600px",
              margin: "0 auto 20px auto",
            }}
          >
            <strong>üìç Current URL:</strong>
            <br />
            <code style={{ fontSize: "12px", wordBreak: "break-all" }}>
              {currentUrl}
            </code>
            <br />
            <br />
            <strong>Hash:</strong>{" "}
            <code>{window.location.hash || "(none)"}</code>
            <br />
            <strong>ActiveApp:</strong> <code>{activeApp.parentId}</code>
          </div>

          <p style={{ fontSize: "16px", marginBottom: "20px" }}>
            ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π <strong>"Sales Visitor"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö Micro Frontend
          </p>

          <div
            style={{
              padding: "15px",
              backgroundColor: "#fff7e6",
              borderRadius: "8px",
              maxWidth: "500px",
              margin: "0 auto",
            }}
          >
            <strong>üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</strong>
            <ol style={{ textAlign: "left", marginTop: "10px" }}>
              <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π "‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢" ‚Üí "Sales Visitor"</li>
              <li>
                ‡∏î‡∏π URL ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô <code>/#/sales/sales-visitor</code>
              </li>
              <li>‡πÉ‡∏ô Remote App ‡∏Ñ‡∏•‡∏¥‡∏Å "New Visit Report"</li>
              <li>
                ‡∏î‡∏π URL ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô <code>/#/sales/sales-visitor/new</code>
              </li>
              <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Edit" ‡πÉ‡∏ô table</li>
              <li>
                ‡∏î‡∏π URL ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô <code>/#/sales/sales-visitor/edit/001</code>
              </li>
            </ol>
          </div>
        </div>
      );
    }
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Sales App ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isSalesApp =
      activeApp.parentId === "sales" ||
      location.pathname.includes("/sales") ||
      window.location.hash.includes("/sales/sales-visitor");

    if (isSalesApp) {
      return (
        <div>
          <Suspense
            fallback={<RemoteLoadingFallback appName="Sales Application" />}
          >
            <SalesApp />
          </Suspense>
        </div>
      );
    }

    const renderRemoteApp = () => {
      switch (activeApp.parentId) {
        case "sales":
        case "wms":
          return (
            <RemoteErrorFallback
              appName="WMS Application"
              error="Module ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
            />
          );

        default:
          return (
            <div
              style={{
                display: "flex",
                justifyContent: "center",
                alignItems: "center",
                height: "100%",
                padding: "40px",
              }}
            >
              <Card style={{ maxWidth: "600px", textAlign: "center" }}>
                <div style={{ padding: "40px 20px" }}>
                  <RocketOutlined
                    style={{
                      fontSize: "64px",
                      color: "#1890ff",
                      marginBottom: "24px",
                    }}
                  />
                  <Title level={3}>
                    Application "{activeApp.parentId}" ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤
                  </Title>
                  <Paragraph>
                    ‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ Application ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Microfrontend
                    Architecture ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
                  </Paragraph>
                  <div style={{ marginTop: "24px" }}>
                    <Button type="primary" style={{ marginRight: "12px" }}>
                      ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°
                    </Button>
                    <Button>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</Button>
                  </div>
                </div>
              </Card>
            </div>
          );
      }
    };

    return (
      <div style={{ width: "100%", height: "100%" }}>{renderRemoteApp()}</div>
    );
  }, [activeApp, menuItems, location, currentUrl]);

  return (
    <div style={{ position: "relative", width: "100%", height: "100%" }}>
      {renderContent}

      {permissionStatus.showLoading && activeApp.parentId !== "home" && (
        <div
          style={{
            position: "absolute",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: "rgba(255, 255, 255, 0.9)",
            backdropFilter: "blur(2px)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
            zIndex: 1000,
          }}
        >
          <div style={{ textAlign: "center" }}>
            <Spin
              size="large"
              indicator={<LoadingOutlined style={{ fontSize: 40 }} spin />}
            />
            <p
              style={{
                margin: "16px 0 0 0",
                color: "#64748b",
                fontSize: "16px",
                fontWeight: 500,
              }}
            >
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≥‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...
            </p>
            <p
              style={{
                margin: "8px 0 0 0",
                color: "#94a3b8",
                fontSize: "14px",
              }}
            >
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
            </p>
          </div>
        </div>
      )}

      {!permissionStatus.hasPermission &&
        !permissionStatus.showLoading &&
        activeApp.parentId !== "home" && <NoPermissionOverlay />}

    </div>
  );
};

export default DashboardContent;
